<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guess The Truth</title><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script><style>
body{font-family:sans-serif;background:#0f172a;color:white;text-align:center;padding:20px}
.card{background:#1e293b;padding:20px;margin:10px auto;border-radius:12px;max-width:450px}
button{padding:10px;margin:5px;border:none;border-radius:8px;background:#38bdf8;color:white;font-weight:bold}
.small{font-size:14px;opacity:0.8}
input{padding:8px;border-radius:6px;border:none}
</style></head><body>
<h1>üé£ Guess The Truth</h1>
<div id="app"></div><script src="questions.js"></script><script>

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCktzF_jcDDLPq5r3qvZFA36Sr8hmWGVKs",
  authDomain: "soungfisfluke.firebaseapp.com",
  databaseURL: "https://soungfisfluke-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "soungfisfluke",
  storageBucket: "soungfisfluke.firebasestorage.app",
  messagingSenderId: "759522644508",
  appId: "1:759522644508:web:f7b5b762d5f7ba03dac5d9",
  measurementId: "G-CBYFQ4RY3H"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomCode=""
let playerId=Math.random().toString(36).substring(2)
let playerName=""
let isHost=false
let roomRef=null

// ================= HOME =================

function renderHome(){
 document.getElementById("app").innerHTML=`
 <div class="card">
   <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì"><br><br>
   <button onclick="createRoom()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button><br><br>
   <input id="roomInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á"><br>
   <button onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
 </div>`
}

// ================= CREATE =================

function createRoom(){
 playerName=document.getElementById("name").value.trim()
 if(!playerName)return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô")

 roomCode=Math.random().toString(36).substring(2,6).toUpperCase()
 isHost=true
 roomRef=db.ref("rooms/"+roomCode)

 roomRef.set({
   state:"lobby",
   host:playerId,
   players:{}
 }).then(()=>{
   joinRoom()
 })
}

// ================= JOIN =================

function joinRoom(){
  playerName = document.getElementById("name").value.trim()
  if(!playerName) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô")

  if(!isHost){
    roomCode = document.getElementById("roomInput").value.toUpperCase()
    if(!roomCode) return alert("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô")
    roomRef = db.ref("rooms/" + roomCode)  // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
  }

  roomRef.child("players/"+playerId).set({
    name: playerName,
    score: 0
  })

  roomRef.child("players/"+playerId).onDisconnect().remove()
  listenRoom()
}


// ================= LISTEN =================

function listenRoom(){
 roomRef.on("value",snap=>{
   const data=snap.val()
   if(!data)return renderHome()

   isHost=data.host===playerId

   switch(data.state){
     case "lobby": showLobby(data); break
     case "talk": showTalk(data); break
     case "guess": showGuess(data); break
     case "result": showResult(data); break
   }
 })
}

// ================= LOBBY =================

function showLobby(data){
 let html=`<div class="card"><h3>‡∏´‡πâ‡∏≠‡∏á: ${roomCode}</h3>`

 for(let id in data.players){
   html+=`<p>${data.players[id].name}</p>`
 }

 if(isHost){
   html+=`<button onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>`
 }

 html+=`</div>`
 document.getElementById("app").innerHTML=html
}

// ================= START =================

function startGame(){
 roomRef.child("players").once("value").then(snapshot=>{
   const playersData=snapshot.val()
   const ids=Object.keys(playersData)
   if(ids.length<3) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô")

   const guesser=ids[Math.floor(Math.random()*ids.length)]
   let truth
   do{
     truth=ids[Math.floor(Math.random()*ids.length)]
   }while(truth===guesser)

   const q=getRandomQuestion()

   roomRef.update({
     guesser,
     truth,
     question:q.question,
     answer:q.answer,
     guessed:null,
     scored:null,
     state:"talk"
   })
 })
}

// ================= TALK =================

function showTalk(data){
 const isGuesser=data.guesser===playerId
 const isTruth=data.truth===playerId

 let html=`<div class="card">
 <h3>${data.question}</h3>`

 if(isGuesser){
   html+=`<p class="small">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏≤‡∏¢ üëë</p>`
 }else{
   html+=`<p class="small">
   ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á: <b>${data.answer}</b><br>
   ${isTruth?"‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á üòá":"‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏Å‡∏´‡∏Å üòà"}
   </p>`
 }

 if(isHost){
   html+=`<button onclick="roomRef.update({state:'guess'})">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏¢</button>`
 }

 html+=`</div>`
 document.getElementById("app").innerHTML=html
}

// ================= GUESS =================

function showGuess(data){

 if(playerId!==data.guesser){
   document.getElementById("app").innerHTML=
   `<div class="card"><h3>‡∏£‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</h3></div>`
   return
 }

 let html=`<div class="card">
 <h3>${data.question}</h3>
 <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á</p>
 </div>`

 for(let id in data.players){
   if(id===data.guesser) continue
   html+=`<div class="card">
     <p>${data.players[id].name}</p>
     <button onclick="selectGuess('${id}')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
   </div>`
 }

 document.getElementById("app").innerHTML=html
}

function selectGuess(id){
 roomRef.update({
   guessed:id,
   scored:false,   // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥
   state:"result"
 })
}

// ================= RESULT =================

function showResult(data){

 const correct=data.guessed===data.truth

 // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 if(!data.scored && isHost){

   if(correct){
     roomRef.child("players/"+data.guesser+"/score")
       .transaction(s=>(s||0)+1)
   }

   roomRef.update({ scored:true })
 }

 let html=`<div class="card">
 <h3>‡πÄ‡∏â‡∏•‡∏¢</h3>
 <p>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á: ${data.answer}</p>
 <p>‡∏Ñ‡∏ô‡∏û‡∏π‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á: ${data.players[data.truth].name}</p>
 <p>${correct?"‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å üéâ":"‡∏ó‡∏≤‡∏¢‡∏ú‡∏¥‡∏î ‚ùå"}</p>
 </div>
 <div class="card"><h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>`

 for(let id in data.players){
   html+=`<p>${data.players[id].name}: ${data.players[id].score||0}</p>`
 }

 if(isHost){
   html+=`<button onclick="resetRound()">‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>`
 }

 html+=`</div>`
 document.getElementById("app").innerHTML=html
}

function resetRound(){
 roomRef.update({
   state:"lobby",
   guesser:null,
   truth:null,
   question:null,
   answer:null,
   guessed:null,
   scored:null
 })
}

renderHome()

</script></body>
</html>